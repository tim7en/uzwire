{% extends 'base.html' %}
{% load i18n utils %}

{% block title %}{% trans "UzWire — Dashboard" %}{% endblock %}

{% block content %}
  <section class="mb-10">
    <div class="rounded-3xl border border-slate-800 bg-gradient-to-br from-slate-900 via-slate-950 to-black p-8 md:p-10 uz-fadein">
      <div class="flex flex-col gap-6 md:flex-row md:items-center md:justify-between">
        <div class="max-w-3xl">
          <div class="inline-flex items-center gap-2 text-xs text-slate-300 border border-slate-800 rounded-full px-3 py-1 mb-4">
            <span class="w-2 h-2 rounded-full bg-emerald-400"></span>
            {% trans "Welcome back" %}, {{ request.user.username }}
          </div>
          <h1 class="text-3xl md:text-5xl font-semibold tracking-tight">{% trans "Build a portfolio. Track it like a pro." %}</h1>
          <p class="mt-4 text-slate-300 text-base md:text-lg">
            {% trans "Paper-track your own portfolio or use sector presets, then compare performance vs S&P 500 and Nasdaq with daily data." %}
          </p>
        </div>

        <div class="grid gap-3 w-full md:w-[360px]">
          <a href="#portfolio" class="px-4 py-3 rounded bg-emerald-600 hover:bg-emerald-500 text-center">
            {% trans "Create a portfolio" %}
          </a>
          <a href="#questions" class="px-4 py-3 rounded bg-slate-800 hover:bg-slate-700 text-center">
            {% trans "Ask preset questions" %}
          </a>
        </div>
      </div>

      <div class="mt-8 grid gap-4 md:grid-cols-3">
        <div class="rounded-2xl border border-slate-800 bg-slate-900/70 p-5 uz-hoverlift">
          <div class="text-xs text-slate-400">{% trans "Step 1" %}</div>
          <div class="text-lg font-semibold mt-1">{% trans "Load your data" %}</div>
          <div class="text-sm text-slate-300 mt-2">{% trans "Start with a preset portfolio or paste your own tickers with weights." %}</div>
        </div>
        <div class="rounded-2xl border border-slate-800 bg-slate-900/70 p-5 uz-hoverlift">
          <div class="text-xs text-slate-400">{% trans "Step 2" %}</div>
          <div class="text-lg font-semibold mt-1">{% trans "Benchmark" %}</div>
          <div class="text-sm text-slate-300 mt-2">{% trans "Compare against S&P 500 and Nasdaq across 5/10/15 years." %}</div>
        </div>
        <div class="rounded-2xl border border-slate-800 bg-slate-900/70 p-5 uz-hoverlift">
          <div class="text-xs text-slate-400">{% trans "Step 3" %}</div>
          <div class="text-lg font-semibold mt-1">{% trans "Improve" %}</div>
          <div class="text-sm text-slate-300 mt-2">{% trans "Get explainable insights: risk, concentration, and what to rebalance." %}</div>
        </div>
      </div>
    </div>
  </section>

  <section class="mb-12" id="overview">
    <div class="flex items-end justify-between gap-4 mb-4">
      <div>
        <h2 class="text-2xl font-semibold">{% trans "Market overview" %}</h2>
        <p class="text-slate-400 text-sm">{% trans "Cached quotes from the last update." %}</p>
      </div>
    </div>

    <div class="grid gap-4 md:grid-cols-3">
      {% for r in latest %}
        <div class="rounded-2xl border border-slate-800 bg-slate-900 p-5 uz-hoverlift">
          <div class="text-xs text-slate-400">{{ r.category }}</div>
          <div class="text-lg font-semibold mt-1">{{ r.name }}</div>
          <div class="mt-2 flex items-baseline justify-between">
            <div class="text-xl font-semibold">
              {% if r.price is not None %}{{ r.price|floatformat:2 }}{% else %}<span class="text-slate-500">—</span>{% endif %}
            </div>
            <div class="text-sm">
              {% if r.change_pct is not None %}
                <span class="{% if r.change_pct >= 0 %}text-emerald-300{% else %}text-rose-300{% endif %}">
                  {{ r.change_pct|floatformat:2 }}%
                </span>
              {% else %}
                <span class="text-slate-500">—</span>
              {% endif %}
            </div>
          </div>
        </div>
      {% empty %}
        <div class="rounded-2xl border border-slate-800 bg-slate-900 p-6 text-slate-300">{% trans "Market data is updating…" %}</div>
      {% endfor %}
    </div>
  </section>

  <section class="mb-12" id="portfolio">
    <div class="flex items-end justify-between gap-4 mb-4">
      <div>
        <h2 class="text-2xl font-semibold">{% trans "Portfolio builder" %}</h2>
        <p class="text-slate-400 text-sm">{% trans "Paper tracking. No broker connection required." %}</p>
      </div>
    </div>

    <div class="grid gap-6 lg:grid-cols-2">
      <div class="rounded-2xl border border-slate-800 bg-slate-900 p-6">
        <div class="text-sm text-slate-400 mb-4">{% trans "Create portfolio" %}</div>
        <form method="post" action="{% url 'dashboard:create_portfolio' %}" class="space-y-4">
          {% csrf_token %}
          <div>
            <label class="block text-sm text-slate-300 mb-1">{% trans "Name" %}</label>
            <input name="name" required class="w-full px-3 py-2 rounded bg-slate-950 border border-slate-800" placeholder="My portfolio" />
          </div>
          <div>
            <label class="block text-sm text-slate-300 mb-1">{% trans "Preset" %}</label>
            <select name="preset" class="w-full px-3 py-2 rounded bg-slate-950 border border-slate-800">
              <option value="">{% trans "Custom" %}</option>
              {% for k, p in presets.items %}
                <option value="{{ k }}">{{ p.label }}</option>
              {% endfor %}
            </select>
            <div class="text-xs text-slate-500 mt-1">{% trans "Or paste your own tickers and weights below." %}</div>
          </div>
          <div>
            <label class="block text-sm text-slate-300 mb-1">{% trans "Holdings" %}</label>
            <textarea name="custom_lines" rows="6" class="w-full px-3 py-2 rounded bg-slate-950 border border-slate-800" placeholder="aapl.us 40
msft.us 30
spy.us 30"></textarea>
            <div class="text-xs text-slate-500 mt-1">{% trans "Format: SYMBOL WEIGHT (weights are normalized)." %}</div>
          </div>
          <button class="px-4 py-2 rounded bg-emerald-600 hover:bg-emerald-500">{% trans "Save" %}</button>
        </form>
      </div>

      <div class="rounded-2xl border border-slate-800 bg-slate-900 p-6">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-sm text-slate-400">{% trans "What if" %}</div>
            <div class="text-lg font-semibold mt-1">
              {% if selected_portfolio %}{{ selected_portfolio.name }}{% else %}{% trans "Preset:" %} {{ selected_preset_label }}{% endif %}
            </div>
          </div>
          {% if portfolios %}
            <div>
              <select class="px-2 py-1 rounded bg-slate-950 border border-slate-800 text-sm" onchange="if (this.value) window.location.href='?portfolio=' + this.value">
                <option value="">{% trans "Select" %}</option>
                {% for p in portfolios %}
                  <option value="{{ p.id }}" {% if selected_portfolio and selected_portfolio.id == p.id %}selected{% endif %}>{{ p.name }}</option>
                {% endfor %}
              </select>
            </div>
          {% endif %}
        </div>

        <div class="mt-4 rounded-xl border border-slate-800 bg-slate-950 p-4">
          <div class="text-xs text-slate-400">{% trans "Performance vs benchmarks" %}</div>
          <table class="w-full text-sm mt-3">
            <thead class="text-slate-500">
              <tr>
                <th class="text-left py-2">{% trans "Horizon" %}</th>
                <th class="text-right py-2">{% trans "Portfolio" %}</th>
                <th class="text-right py-2">S&P 500</th>
                <th class="text-right py-2">Nasdaq</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-800">
              {% for k, v in portfolio_backtests.items %}
                <tr>
                  <td class="py-2 text-slate-300">{{ k|upper }}</td>
                  <td class="py-2 text-right">
                    {% if v.end_value is not None %}
                      <div class="font-semibold">${{ v.end_value|floatformat:0 }}</div>
                      <div class="text-xs text-slate-500">{% trans "CAGR" %}: {% if v.cagr_pct is not None %}{{ v.cagr_pct|floatformat:2 }}%{% else %}—{% endif %}</div>
                    {% else %}
                      <span class="text-slate-500">—</span>
                    {% endif %}
                  </td>
                  <td class="py-2 text-right">
                    {% with b=benchmarks.spx|get_item:k %}
                      {% if b.end_value is not None %}
                        <div class="font-semibold">${{ b.end_value|floatformat:0 }}</div>
                        <div class="text-xs text-slate-500">{% trans "CAGR" %}: {% if b.cagr_pct is not None %}{{ b.cagr_pct|floatformat:2 }}%{% else %}—{% endif %}</div>
                      {% else %}
                        <span class="text-slate-500">—</span>
                      {% endif %}
                    {% endwith %}
                  </td>
                  <td class="py-2 text-right">
                    {% with b=benchmarks.ndx|get_item:k %}
                      {% if b.end_value is not None %}
                        <div class="font-semibold">${{ b.end_value|floatformat:0 }}</div>
                        <div class="text-xs text-slate-500">{% trans "CAGR" %}: {% if b.cagr_pct is not None %}{{ b.cagr_pct|floatformat:2 }}%{% else %}—{% endif %}</div>
                      {% else %}
                        <span class="text-slate-500">—</span>
                      {% endif %}
                    {% endwith %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
          <div class="text-xs text-slate-500 mt-3">{% trans "What-if assumes a $10,000 investment and uses best-effort daily history." %}</div>
        </div>

        <div class="mt-4 grid gap-3 md:grid-cols-6">
          <div class="rounded-xl border border-slate-800 bg-slate-950 p-4 uz-hoverlift">
            <div class="text-xs text-slate-400">{% trans "Total return" %}</div>
            <div class="text-lg font-semibold mt-1">
              {% if insights.total_return_pct is not None %}{{ insights.total_return_pct|floatformat:2 }}%{% else %}—{% endif %}
            </div>
          </div>
          <div class="rounded-xl border border-slate-800 bg-slate-950 p-4 uz-hoverlift">
            <div class="text-xs text-slate-400">{% trans "CAGR" %}</div>
            <div class="text-lg font-semibold mt-1">
              {% if insights.cagr_pct is not None %}{{ insights.cagr_pct|floatformat:2 }}%{% else %}—{% endif %}
            </div>
          </div>
          <div class="rounded-xl border border-slate-800 bg-slate-950 p-4 uz-hoverlift">
            <div class="text-xs text-slate-400">{% trans "Max drawdown" %}</div>
            <div class="text-lg font-semibold mt-1">
              {% if insights.max_drawdown_pct is not None %}{{ insights.max_drawdown_pct|floatformat:2 }}%{% else %}—{% endif %}
            </div>
            {% if insights.drawdown %}
              <div class="text-xs text-slate-500 mt-1">
                {{ insights.drawdown.peak_date }} → {{ insights.drawdown.trough_date }}
              </div>
            {% endif %}
          </div>
          <div class="rounded-xl border border-slate-800 bg-slate-950 p-4 uz-hoverlift">
            <div class="text-xs text-slate-400">{% trans "Volatility" %}</div>
            <div class="text-lg font-semibold mt-1">
              {% if insights.vol_pct is not None %}{{ insights.vol_pct|floatformat:2 }}%{% else %}—{% endif %}
            </div>
          </div>

          <div class="rounded-xl border border-slate-800 bg-slate-950 p-4 uz-hoverlift">
            <div class="text-xs text-slate-400">{% trans "Correlation" %} (S&P 500)</div>
            <div class="text-lg font-semibold mt-1">
              {% if insights.corr_spx is not None %}{{ insights.corr_spx|floatformat:2 }}{% else %}—{% endif %}
            </div>
          </div>

          <div class="rounded-xl border border-slate-800 bg-slate-950 p-4 uz-hoverlift">
            <div class="text-xs text-slate-400">{% trans "Best / worst month" %}</div>
            <div class="text-sm font-semibold mt-1">
              {% if insights.best_worst_month %}
                <div>
                  {% trans "Best" %}: {{ insights.best_worst_month.best.year }}-{{ insights.best_worst_month.best.month }}
                  ({{ insights.best_worst_month.best.return_pct|floatformat:2 }}%)
                </div>
                <div class="text-slate-300">
                  {% trans "Worst" %}: {{ insights.best_worst_month.worst.year }}-{{ insights.best_worst_month.worst.month }}
                  ({{ insights.best_worst_month.worst.return_pct|floatformat:2 }}%)
                </div>
              {% else %}
                —
              {% endif %}
            </div>
          </div>
        </div>

        <div class="mt-4 h-44">
          <canvas id="portfolioChart"></canvas>
        </div>
      </div>
    </div>
  </section>

  <section class="mb-12" id="questions">
    <div class="flex items-end justify-between gap-4 mb-4">
      <div>
        <h2 class="text-2xl font-semibold">{% trans "Preset questions" %}</h2>
        <p class="text-slate-400 text-sm">{% trans "One-click prompts that guide decisions." %}</p>
      </div>
    </div>

    <div class="rounded-2xl border border-slate-800 bg-slate-900 p-6">
      <div class="flex flex-wrap gap-2">
        <button type="button" class="qBtn px-3 py-2 rounded bg-slate-800 hover:bg-slate-700 text-sm" data-q="Where are my biggest risks?">{% trans "Where are my biggest risks?" %}</button>
        <button type="button" class="qBtn px-3 py-2 rounded bg-slate-800 hover:bg-slate-700 text-sm" data-q="Did I beat S&P 500 over 5 years?">{% trans "Did I beat S&P 500 over 5 years?" %}</button>
        <button type="button" class="qBtn px-3 py-2 rounded bg-slate-800 hover:bg-slate-700 text-sm" data-q="What should I rebalance this month?">{% trans "What should I rebalance this month?" %}</button>
        <button type="button" class="qBtn px-3 py-2 rounded bg-slate-800 hover:bg-slate-700 text-sm" data-q="How sensitive am I to USD/UZS?">{% trans "How sensitive am I to USD/UZS?" %}</button>
      </div>

      <div class="mt-5 grid gap-4 md:grid-cols-2">
        <div class="rounded-xl border border-slate-800 bg-slate-950 p-5">
          <div class="text-xs text-slate-400">{% trans "Your question" %}</div>
          <textarea id="qText" class="mt-2 w-full px-3 py-2 rounded bg-slate-950 border border-slate-800" rows="4" placeholder="{% trans 'Pick a question above…' %}"></textarea>
          <button type="button" id="qRun" class="mt-3 px-4 py-2 rounded bg-emerald-600 hover:bg-emerald-500">{% trans "Run" %}</button>
        </div>
        <div class="rounded-xl border border-slate-800 bg-slate-950 p-5">
          <div class="text-xs text-slate-400">{% trans "Answer" %}</div>
          <div id="qAnswer" class="mt-2 text-sm text-slate-300">
            {% trans "This is the interactive insights area. Next step: we will connect these answers to your portfolio analytics." %}
          </div>
        </div>
      </div>
    </div>
  </section>

  <script>
    // Tiny dashboard interactions (lightweight & theme-safe)
    (function(){
      const btns = document.querySelectorAll('.qBtn');
      const qText = document.getElementById('qText');
      const qRun = document.getElementById('qRun');
      const qAnswer = document.getElementById('qAnswer');
      btns.forEach(b => b.addEventListener('click', () => { if (qText) qText.value = b.dataset.q || ''; }));
      if (qRun) {
        qRun.addEventListener('click', () => {
          if (!qText || !qAnswer) return;
          const q = (qText.value || '').trim();
          if (!q) return;
          qAnswer.textContent = 'Working on: ' + q + ' (coming soon)';
        });
      }
    })();
  </script>

  <script>
    // Portfolio chart (daily index series)
    (function(){
      const canvas = document.getElementById('portfolioChart');
      if (!canvas || !window.Chart) return;

      const theme = document.documentElement.dataset.theme || 'dark';
      const styles = getComputedStyle(document.documentElement);
      const accent = styles.getPropertyValue('--accent').trim() || '#22c55e';
      const muted = styles.getPropertyValue('--muted').trim() || '#94a3b8';
      const grid = styles.getPropertyValue('--border').trim() || '#1e293b';

      const params = new URLSearchParams(window.location.search);
      const pid = params.get('portfolio');
      const preset = params.get('preset') || '{{ selected_preset|escapejs }}';
      const url = pid ? `/api/app/portfolio/series/?portfolio=${encodeURIComponent(pid)}&days=1260` : `/api/app/portfolio/series/?preset=${encodeURIComponent(preset)}&days=1260`;

      async function load(){
        try {
          const resp = await fetch(url, { headers: { 'Accept': 'application/json' } });
          if (!resp.ok) return;
          const data = await resp.json();
          const series = data.series || [];
          if (!series.length) return;
          const labels = series.map(p => new Date(p.t).toLocaleDateString(document.documentElement.lang || undefined));
          const values = series.map(p => p.p);
          const spx = series.map(p => p.spx);
          const ndx = series.map(p => p.ndx);

          new Chart(canvas.getContext('2d'), {
            type: 'line',
            data: {
              labels,
              datasets: [
                { label: 'Portfolio', data: values, borderColor: accent, backgroundColor: accent, tension: 0.25, pointRadius: 0 },
                { label: 'S&P 500', data: spx, borderColor: '#60a5fa', backgroundColor: '#60a5fa', tension: 0.25, pointRadius: 0 },
                { label: 'Nasdaq', data: ndx, borderColor: '#f59e0b', backgroundColor: '#f59e0b', tension: 0.25, pointRadius: 0 },
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: true, labels: { color: muted } } },
              scales: {
                x: { ticks: { color: muted, maxTicksLimit: 6 }, grid: { color: grid } },
                y: { ticks: { color: muted }, grid: { color: grid } },
              }
            }
          });
        } catch(e) {}
      }
      load();
    })();
  </script>
{% endblock %}
